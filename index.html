<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Etiketovac√≠ aplikace</title>
  <!-- ======= STYLES ======= -->
  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1251a1;
      --bg: #f4f4f4;
      --card: #fff;
      --green: #e8fbe8;   /* v√Ωbƒõr jazyka */
      --numpad: #fff5e6;  /* pozad√≠ numpadu */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: var(--green);
      transition: background 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding-bottom: 40px;
    }
    body.step-ean { background: var(--bg); }

    /* Hlavn√≠ titulek */
    #stepTitle { margin: 90px 0 28px; font-size: 28px; font-weight: 600; color: #333; text-align: center; }

    /* Jazykov√© dla≈ædice */
    .language-select { display: flex; flex-direction: column; align-items: center; gap: 18px; margin-bottom: 32px; }
    .lang-btn {
      width: 240px; height: 70px; border: 2px solid #ddd; background: #fff; border-radius: 10px;
      font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 10px;
      cursor: pointer; transition: background 0.2s;
    }
    .lang-btn:hover { background: #eaeaea; }
    .flag { height: 26px; }

    /* Glob√°ln√≠ p≈ôep√≠naƒç jazyka */
    #langToggle {
      position: fixed; top: 14px; right: 14px;
      border: none; background: #fff; border-radius: 50%; width: 46px; height: 46px;
      display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,.15);
      cursor: pointer; font-size: 22px;
    }

    /* Vyhled√°vac√≠ pruh */
    #searchBar { display: none; text-align: center; margin-bottom: 20px; }
    #eanInput { font-size: 22px; padding: 12px; width: 260px; border-radius: 8px; border: 1px solid #bbb; margin-right: 6px; }
    #resetBtn { border: none; background: #ddd; padding: 11px 14px; border-radius: 8px; cursor: pointer; font-size: 18px; }
    #searchBtn { padding: 12px 28px; font-size: 20px; border: none; border-radius: 8px; background: var(--primary); color: #fff; cursor: pointer; transition: background 0.2s; }
    #searchBtn:hover { background: var(--primary-dark); }

    /* V√Ωsledky */
    #result { margin-top: 20px; width: 96%; max-width: 920px; }
    .card {
      background: var(--card); border-radius: 14px; box-shadow: 0 3px 8px rgba(0,0,0,.12);
      padding: 26px; margin-bottom: 28px;
    }
    .country-btn {
      border: 1px solid #ddd; background: #fff; border-radius: 8px; padding: 8px 14px; font-size: 16px;
      display: inline-flex; align-items: center; gap: 6px; margin: 0 12px 12px 0; cursor: pointer; transition: background 0.2s;
    }
    .country-btn:hover { background: #eee; }
    .label { font-weight: 600; margin-right: 4px; }

    /* Numpad */
    .qty-wrap { background: var(--numpad); border-radius: 12px; padding: 20px; margin-top: 20px; }
    .qty-display { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
    .numpad { display: grid; grid-template-columns: repeat(3, 90px); gap: 16px; justify-content: center; }
    .pad-btn {
      height: 90px; font-size: 26px; border: none; border-radius: 10px; background: #e0e0e0;
      cursor: pointer; transition: background 0.2s;
    }
    .pad-btn:hover { background: #d0d0d0; }
    .print-btn {
      margin-top: 22px; padding: 14px 36px; font-size: 22px; border: none; border-radius: 10px;
      background: var(--primary); color: #fff; cursor: pointer; transition: background 0.2s;
    }
    .print-btn:hover { background: var(--primary-dark); }
  </style>
  <script src="https://labelary.github.io/browser-print-js/js/BrowserPrint-3.0.216.min.js"></script>
</head>
<body class="step-lang">
  <!-- Glob√°ln√≠ p≈ôep√≠naƒç jazyka -->
  <button id="langToggle" title="Zmƒõnit jazyk">üåê</button>

  <!-- Titulek kroku -->
  <h2 id="stepTitle">V√Ωbƒõr jazyka</h2>

  <!-- Dla≈ædice jazyk≈Ø -->
  <div id="langSelect" class="language-select">
    <button class="lang-btn"><img class="flag" src="https://flagcdn.com/24x18/cz.png">ƒåe≈°tina</button>
    <button class="lang-btn"><img class="flag" src="https://flagcdn.com/24x18/de.png">Deutsch</button>
    <button class="lang-btn"><img class="flag" src="https://flagcdn.com/24x18/ua.png">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</button>
    <button class="lang-btn"><img class="flag" src="https://flagcdn.com/24x18/gb.png">English</button>
  </div>

  <!-- Vyhled√°vac√≠ pruh -->
  <div id="searchBar">
    <input type="text" id="eanInput" placeholder="Zadej EAN k√≥d" />
    <button id="resetBtn" title="Vymazat">‚ü≤</button>
    <button id="searchBtn">Hledat</button>
  </div>

  <!-- V√Ωsledky / numpad -->
  <div id="result"></div>

  <!-- ======= SCRIPT ======= -->
  <script>
    /***** 1. P≈ôep√≠n√°n√≠ krok≈Ø *****/
    const body      = document.body;
    const langSel   = document.getElementById('langSelect');
    const searchBar = document.getElementById('searchBar');
    const title     = document.getElementById('stepTitle');
    const eanInput  = document.getElementById('eanInput');
    document.getElementById('langToggle').onclick = resetToLang;

    langSel.addEventListener('click', e => {
      if (e.target.closest('.lang-btn')) {
        langSel.style.display = 'none';
        searchBar.style.display = 'block';
        title.textContent = 'Zadej EAN k√≥d';
        eanInput.focus();
        body.classList.replace('step-lang', 'step-ean');
      }
    });

    function resetToLang() {
      body.classList.replace('step-ean', 'step-lang');
      langSel.style.display = 'flex';
      searchBar.style.display = 'none';
      title.textContent = 'V√Ωbƒõr jazyka';
      document.getElementById('result').innerHTML = '';
    }

    /***** 2. Reset vyhled√°vac√≠ho pole *****/
    document.getElementById('resetBtn').onclick = () => {
      eanInput.value = '';
      document.getElementById('result').innerHTML = '';
      eanInput.focus();
    };

    /***** 3. Utils *****/
    const clean   = s => String(s).replace(/[^0-9]/g, '').trim();
    const flagISO = c => c.slice(0, 2).toLowerCase();
    let rowsByCountry = {}, qty = '';

    /***** 4. Naƒçten√≠ dat z Google Sheets *****/
    async function fetchSheet() {
      const r = await fetch('https://opensheet.elk.sh/1OZ6xgh0IdQntCylrZWA7lJI4CGNVy7O_i53veTuNGLU/TEST');
      if (!r.ok) throw new Error(r.status);
      return r.json();
    }

    /***** 5. Vyhled√°v√°n√≠ EAN *****/
    const resultDiv = document.getElementById('result');
    document.getElementById('searchBtn').onclick = () => searchEAN(eanInput.value);
    eanInput.addEventListener('keydown', e => { if (e.key === 'Enter') searchEAN(e.target.value); });

    async function searchEAN(raw) {
      const ean = clean(raw);
      if (!ean) { alert('Zadejte EAN'); return; }
      resultDiv.textContent = 'Naƒç√≠t√°m‚Ä¶';
      try {
        const data = await fetchSheet();
        const matches = data.filter(r => Object.values(r).some(v => clean(v) === ean));
        if (!matches.length) { resultDiv.textContent = 'EAN nenalezen'; return; }

        // seskup podle zemƒõ
        rowsByCountry = {};
        matches.forEach(r => {
          const c = r.Country || '--';
          (rowsByCountry[c] = rowsByCountry[c] || []).push(r);
        });

        // karta produktu
        const f = matches[0];
        let html = `<div class='card'><h2>${f['N√°zev produktu'] || f.Name}</h2>`;
        html += `<p><span class='label'>EAN:</span>${f.EAN}</p>`;
        html += `<p><span class='label'>ID:</span>${f.ID || '-'}</p>`;
        html += `<p><span class='label'>Label size:</span>${f['Label size'] || '-'}</p>`;
        html += `<p><span class='label'>Typ zbo≈æ√≠:</span>${f['Type of Goods'] || '-'}</p>`;
        html += '<h3>Jazykov√© mutace</h3>';
        for (const c of Object.keys(rowsByCountry)) {
          html += `<button class='country-btn' data-c='${c}'><img class='flag' src='https://flagcdn.com/24x18/${flagISO(c)}.png'>${c}</button>`;
        }
        html += '</div><div id="countryDetails"></div>';
        resultDiv.innerHTML = html;
      } catch (err) {
        console.error(err);
        resultDiv.textContent = 'Chyba naƒç√≠t√°n√≠';
      }
    }

    /***** 6. Mutace & numpad *****/
    resultDiv.addEventListener('click', e => {
      const btn = e.target.closest('.country-btn');
      if (btn) showCountry(btn.dataset.c);
    });

    function resetQty() { qty = ''; updateQty(); }
    function addDigit(d) { if (qty.length < 6) { qty += d; updateQty(); } }
    function updateQty() { const el = document.getElementById('qtyDisplay'); if (el) el.textContent = qty || '0'; }

    function showCountry(country) {
      resetQty();
      const rows = rowsByCountry[country];
      let out = `<div class='card'><h3>Mutace pro ${country}</h3>`;
      rows.forEach(r => {
        out += `<p><span class='label'>Soubor:</span> <a href='https://drive.google.com/open?id=${r['File ID']}' target='_blank'>${r.Link || r.Name}</a></p>`;
      });
      out += `<div class='qty-wrap'><div id='qtyDisplay' class='qty-display'>0</div><div class='numpad' id='numpad'></div>`;
      out += `<button class='print-btn' data-c='${country}'>üñ®Ô∏è Tisk</button></div></div>`;
      document.getElementById('countryDetails').innerHTML = out;

      // vytvo≈ôen√≠ numpadu
      ['1','2','3','4','5','6','7','8','9','C','0','*'].forEach(v => {
        const b = document.createElement('button');
        b.className = 'pad-btn'; b.textContent = v;
        b.onclick = () => v === 'C' ? resetQty() : v === '*' ? null : addDigit(v);
        document.getElementById('numpad').appendChild(b);
      });
    }

    /***** 7. Mapov√°n√≠ Label ‚ûú tisk√°rna *****/
    const printerMap = {
      '60x60': 'Zebra_60x60',
      '60x40': 'Zebra_60x40',
      '100x75': 'Zebra_100x75'
    };

    /***** 8. Tisk *****/
    resultDiv.addEventListener('click', e => {
      const printBtn = e.target.closest('.print-btn');
      if (!printBtn) return;
      const country = printBtn.dataset.c;
      const count   = parseInt(qty) || 0;
      if (count <= 0) { alert('Zadejte mno≈æstv√≠ ‚â• 1'); return; }

      const row  = rowsByCountry[country][0];
      const size = row['Label size'] || 'Default';
      const zpl  = `^XA^CF0,40^FO30,30^FD${row.EAN} - ${country} - ${count}x^FS^XZ`;
      const targetName = printerMap[size] || null;

      if (window.BrowserPrint) {
        BrowserPrint.getPrinters(list => {
          const printer = targetName ? list.find(p => p.name.includes(targetName)) : list[0];
          if (!printer) { alert('Nenalezena tisk√°rna pro '+size); return; }
          printer.send(zpl, () => resetQty(), err => alert('Chyba tisku: '+err));
        }, err => alert('BrowserPrint nenalezl tisk√°rny'));
      } else {
        // fallback ‚Äì zobraz ZPL
        const w = window.open('', '_blank');
        if (w) w.document.write(`<pre>(${size} ‚ûú ${targetName||'default'})\n${zpl.replace(/</g,'&lt;')}</pre>`);
        alert('(Demo) ZPL zobrazeno ‚Äì BrowserPrint nen√≠ dostupn√Ω');
        resetQty();
      }
    });
  </script>
</body>
</html>
